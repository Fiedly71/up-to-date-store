<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Details</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
  <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-2xl mx-auto py-10 px-4">
    <div id="product-details" class="bg-white rounded-xl shadow-lg p-6 mb-6"></div>
    <div id="order-success" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-6">
      <strong class="font-bold">Order Saved!</strong>
      <span class="block">Please visit our store in Champin or use MonCash to complete your payment.</span>
    </div>
  </div>
  <script>
    // --- Supabase Setup ---
    const supabase = window.supabase.createClient(
      'https://okhwcgowtrrtdkssxivp.supabase.co',
      'sb_publishable_o9xgjUjgM7QzjvWARmZjbQ_t_T-Rnfb'
    );

    // --- Get Product ID from URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    if (!productId) {
      document.getElementById('product-details').innerHTML = '<div class="text-red-600">No product ID provided.</div>';
      throw new Error('No product ID');
    }

    // --- Fetch Product Details from AliExpress API ---
    async function fetchProductDetails(id) {
      const res = await fetch(`https://ali-express1.p.rapidapi.com/product/details?product_id=${id}`, {
        method: 'GET',
        headers: {
          'X-RapidAPI-Key': 'd345cf7a9dmsh588ba309bb4807fp11a983jsnc43ad765201f',
          'X-RapidAPI-Host': 'ali-express1.p.rapidapi.com'
        }
      });
      return res.json();
    }

    // --- Calculate Price with Tiered Fee Logic ---
    function calculateFinalPrice(base) {
      const price = parseFloat(base);
      let fee = 0;
      let feeLabel = '';
      if (price < 50) {
        fee = 8;
        feeLabel = '$8 fee';
      } else if (price < 100) {
        fee = 12;
        feeLabel = '$12 fee';
      } else if (price < 200) {
        fee = 20;
        feeLabel = '$20 fee';
      } else {
        fee = price * 0.2;
        feeLabel = '20% fee';
      }
      return { total: (price + fee).toFixed(2), fee, feeLabel };
    }

    // --- Render Product Details ---
    async function renderProduct() {
      const product = await fetchProductDetails(productId);
      if (!product || !product.product_title) {
        document.getElementById('product-details').innerHTML = '<div class="text-red-600">Product not found.</div>';
        return;
      }
      const images = product.product_images || [product.product_main_image_url];
      const priceObj = calculateFinalPrice(product.app_sale_price);
      document.getElementById('product-details').innerHTML = `
        <h1 class="text-2xl font-bold mb-4">${product.product_title}</h1>
        <div class="flex gap-4 mb-4 overflow-x-auto">
          ${images.map(img => `<img src="${img}" class="w-32 h-32 object-contain rounded border" />`).join('')}
        </div>
        <p class="text-xl text-pink-600 font-bold mb-2">$${priceObj.total} USD <span class="text-xs text-gray-500">(${priceObj.feeLabel} applied)</span></p>
        <div class="mb-4 text-gray-700">${product.product_description || ''}</div>
        <div class="bg-blue-50 border border-blue-300 text-blue-800 px-4 py-3 rounded mb-4">
          <b>Logistics Info:</b> This item will be shipped from China to our Miami Hub (<b>8018 NW 66th ST, APT: BP-081444, FLORIDA, MIAMI</b>) before being forwarded to Cap-Haïtien.
        </div>
        <button id="order-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold transition">Confirm Order</button>
      `;
      document.getElementById('order-btn').onclick = () => handleOrder(product, priceObj.total);
    }

    // --- Handle Order with Auth Protection ---
    async function handleOrder(product, price) {
      // Vérifier la session utilisateur
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        // Rediriger vers login avec message
        const params = new URLSearchParams({ message: 'Please create an account to place your order', redirect: window.location.pathname + window.location.search });
        window.location.href = '/login.html?' + params.toString();
        return;
      }
      // Si session, enregistrer la commande
      const { error } = await supabase.from('wholesale_orders').insert([
        {
          product_name: product.product_title,
          ali_item_id: product.product_id,
          total_price_with_fees: price,
          order_status: 'awaiting_payment',
          created_at: new Date().toISOString(),
          user_id: session.user.id
        }
      ]);
      if (error) {
        alert('Order failed. Please try again.');
      } else {
        document.getElementById('order-success').classList.remove('hidden');
      }
    }

    renderProduct();
  </script>
</body>
</html>
